<div class="fixed-background" [style.background-image]="luckyDraw.customBackground() ? 'url(' + luckyDraw.customBackground() + ')' : 'none'">
    <div class="background-animation" *ngIf="!luckyDraw.customBackground()"></div>
    <div class="background-overlay" *ngIf="luckyDraw.customBackground()"></div>
</div>

<header>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1>{{ translation.t().appTitle }}</h1>
            </div>
            <div class="language-selector">
                <button class="lang-btn" [class.active]="translation.currentLang() === 'vi'" (click)="setLang('vi')">üáªüá≥ VN</button>
                <button class="lang-btn" [class.active]="translation.currentLang() === 'en'" (click)="setLang('en')">üá¨üáß EN</button>
            </div>
        </div>
    </nav>
</header>

<main class="draw-container">
    
    <div class="prize-selector" id="prize-selector">
        @for (prize of luckyDraw.prizes(); track $index) {
            <button class="prize-btn" [class.active]="luckyDraw.currentPrize() === prize.name" (click)="luckyDraw.currentPrize.set(prize.name)">
                <span class="prize-icon">{{ prize.icon }}</span>
                <span>{{ prize.name | uppercase }}</span>
            </button>
        }
    </div>

    <div class="display-area">
        <h2 class="current-prize">
            {{ (luckyDraw.currentPrize() || '') | uppercase }}
            @if (luckyDraw.prizeDrawCount()[luckyDraw.currentPrize() || '']) {
                ({{ luckyDraw.prizeDrawCount()[luckyDraw.currentPrize() || ''] }})
            }
        </h2>
        <p class="instruction">{{ translation.t().instruction }}</p>
        
        <div class="numbers-grid">
            @for (digit of displayedDigits(); track $index) {
                <div class="number-box" [class.winner]="winnerInSlot() === $index">
                    <div class="number" [class.rotating]="digitSpinning()[$index]">{{ digit }}</div>
                </div>
            }
        </div>

        <div class="controls">
            <button class="btn-prev" (click)="luckyDraw.navigatePrize(-1)">
                <span>‚óÑ</span>
            </button>
            <button class="btn-draw" [class.spinning]="luckyDraw.isSpinning()" (click)="startDraw()">
                <span>{{ luckyDraw.isSpinning() ? translation.t().btnDrawing : translation.t().btnDraw }}</span>
            </button>
            <button class="btn-next" (click)="luckyDraw.navigatePrize(1)">
                <span>‚ñ∫</span>
            </button>
        </div>
    </div>

    <div class="winners-section">
        <h3>{{ translation.t().winnersTitle }}</h3>
        <div class="winners-list">
            @for (group of getGroupedWinners(); track group[0]) {
                <div class="winner-draw-group" [attr.data-draw-id]="group[0]">
                    @for (winner of (expandedDraws().has(group[0]) ? group[1] : group[1].slice(0, 1)); track $index) {
                        <div class="winner-item">
                            <div class="winner-number">{{ winner.code }}</div>
                            <div class="winner-name">{{ winner.name }}</div>
                            <div class="winner-prize">{{ winner.prize | uppercase }}</div>
                        </div>
                    }
                    @if (group[1].length > 1) {
                        <button class="winner-toggle-btn" (click)="toggleExpand(group[0])">
                            {{ expandedDraws().has(group[0]) ? translation.t().expand : translation.t().showMore + ' (' + (group[1].length - 1) + ')' }}
                        </button>
                    }
                </div>
            }
        </div>
    </div>

    <div class="prize-icons-display">
        @for (prize of luckyDraw.prizes(); track $index) {
            <div class="prize-icon-item" *ngIf="$index < 6">
                {{ prize.icon }}
            </div>
        }
    </div>
</main>

<section class="participants-section">
    <div class="container">
        <h2>{{ translation.t().participantsTitle }}</h2>
        <div class="input-area">
            <textarea id="participants-input" #participantsInput [value]="luckyDraw.participantsRaw()" [placeholder]="translation.t().inputPlaceholder"></textarea>
            <button id="load-participants" class="btn-load" (click)="luckyDraw.setParticipants(participantsInput.value)">{{ translation.t().btnLoad }}</button>
        </div>
        <div class="participants-info">
            <p>{{ translation.t().totalParticipants }} <strong id="total-participants">{{ luckyDraw.participants().length }}</strong></p>
            <p>{{ translation.t().remainingParticipants }} <strong id="remaining-participants">{{ luckyDraw.remainingParticipants().length }}</strong></p>
        </div>
    </div>
</section>

<section class="settings-section">
    <div class="container">
        <h2>{{ translation.t().settingsTitle }}</h2>
        <div class="settings-grid">
            <div class="settings-group">
                <h3>‚è±Ô∏è {{ translation.t().timingSettings }}</h3>
                <div class="setting-item">
                    <label for="spin-duration">{{ translation.t().spinDuration }}</label>
                    <input type="number" id="spin-duration" [(ngModel)]="luckyDraw.settings().spinDuration" min="3" max="30">
                </div>
                <div class="setting-item">
                    <label for="digit-delay">{{ translation.t().digitDelay }}</label>
                    <input type="number" id="digit-delay" [(ngModel)]="luckyDraw.settings().digitDelay" min="0.5" max="5" step="0.5">
                </div>
            </div>

            <div class="settings-group">
                <h3>üé® {{ translation.t().bgCustomization }}</h3>
                <div class="background-upload">
                    <div class="setting-item">
                        <input type="file" id="background-upload" #backgroundUpload (change)="handleBackgroundUpload($event)" accept="image/*" style="display: none;">
                        <button id="btn-upload-bg" class="btn-upload-bg" (click)="backgroundUpload.click()">{{ translation.t().btnUploadBg }}</button>
                        <span class="setting-hint">{{ translation.t().uploadHint }}</span>
                    </div>
                </div>
                <div class="setting-item">
                    <button id="btn-reset-bg" class="btn-reset-bg" (click)="luckyDraw.setBackground(null)">{{ translation.t().btnResetBg }}</button>
                </div>
                <div id="background-preview" class="background-preview" [style.background-image]="luckyDraw.customBackground() ? 'url(' + luckyDraw.customBackground() + ')' : 'none'">
                    <div class="preview-text" [class.success]="luckyDraw.customBackground()">
                        {{ luckyDraw.customBackground() ? translation.t().bgUploaded : translation.t().noCustomBg }}
                    </div>
                    <div class="preview-overlay" *ngIf="luckyDraw.customBackground()">{{ translation.t().currentBg }}</div>
                </div>
            </div>

            <div class="settings-group prize-settings-dynamic">
                <h3>üèÜ {{ translation.t().managePrizes }}</h3>
                <div id="prizes-list">
                    @for (prize of luckyDraw.prizes(); track $index) {
                        <div class="prize-item-config">
                            <div class="prize-item-header">
                                <input class="prize-icon-input" [(ngModel)]="prize.icon">
                                <input class="prize-name-input" [(ngModel)]="prize.name">
                                <button class="btn-remove-prize" (click)="luckyDraw.removePrize($index)">‚ùå</button>
                            </div>
                            <div class="prize-item-details">
                                <div class="prize-detail-field">
                                    <label>{{ translation.t().prizeCount }}</label>
                                    <input type="number" class="prize-count-input" [(ngModel)]="prize.count">
                                </div>
                                <div class="prize-detail-field">
                                    <label>{{ translation.t().prizeReward }}</label>
                                    <input type="text" class="prize-reward-input" [(ngModel)]="prize.reward" [placeholder]="translation.t().rewardPlaceholder">
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <button class="btn-add-prize" (click)="luckyDraw.addNewPrize()">{{ translation.t().btnAddPrize }}</button>
            </div>
        </div>
        <div class="settings-actions">
            <button id="save-settings" class="btn-save-settings" (click)="saveSettings()">{{ translation.t().btnSaveSettings }}</button>
            <button id="reset-settings" class="btn-reset-settings" (click)="resetSettings()">{{ translation.t().btnResetSettings }}</button>
        </div>
    </div>
</section>

<!-- Congratulations Popup -->
<div class="popup-overlay" [class.show]="showPopup()">
    <div class="popup-content">
        <div class="popup-icon">üéâ</div>
        <h2 class="popup-title">{{ translation.t().congratulations }}</h2>
        <div class="popup-subtitle">{{ translation.t().prizeLabel }} {{ (lastWinners().length > 0 ? lastWinners()[0].prize : '') | uppercase }}</div>
        <div class="popup-count">{{ translation.t().totalWinners }}: {{ lastWinners().length }} {{ translation.t().people }}</div>
        <div class="popup-winners-container" [class.multi-column]="lastWinners().length > 6">
            @for (winner of lastWinners(); track $index) {
                <div class="popup-winner-item">
                    <div class="popup-winner-position">#{{ $index + 1 }}</div>
                    <div class="popup-winner-details">
                        <div class="popup-number">{{ winner.code }}</div>
                        <div class="popup-name">{{ winner.name }}</div>
                    </div>
                </div>
            }
        </div>
        <button class="popup-close" (click)="showPopup.set(false)">{{ translation.t().btnClose }}</button>
    </div>
</div>

<footer>
    <div class="container">
        <p>&copy; 2026 Lucky Draw. All rights reserved.</p>
    </div>
</footer>

<router-outlet />
