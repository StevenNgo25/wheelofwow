<div class="card">
  <div class="header">
    <h3>Qu·∫£n l√Ω Users</h3>
    <input
      type="text"
      placeholder="T√¨m ki·∫øm user..."
      class="search-box"
      [ngModel]="searchQuery()"
      (input)="onSearch($event)"
    />
  </div>

  <div class="table-responsive">
    <table class="data-table">
      <thead>
        <tr>
          <th>Avatar</th>
          <th (click)="onSort('full_name')" class="clickable">
            T√™n
            <span *ngIf="sortField() === 'full_name'">{{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
          </th>
          <th (click)="onSort('email')" class="clickable">
            Email
            <span *ngIf="sortField() === 'email'">{{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
          </th>
          <th (click)="onSort('role')" class="clickable">
            Quy·ªÅn
            <span *ngIf="sortField() === 'role'">{{ sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
          </th>
          <th (click)="onSort('subscription_tier')" class="clickable">
            G√≥i
            <span *ngIf="sortField() === 'subscription_tier'">{{
              sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº'
            }}</span>
          </th>
          <th (click)="onSort('created_at')" class="clickable">
            Ng√†y t·∫°o
            <span *ngIf="sortField() === 'created_at'">{{
              sortOrder() === 'asc' ? '‚ñ≤' : '‚ñº'
            }}</span>
          </th>
          <th>Tr·∫°ng th√°i</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        @if (loading()) {
          <tr>
            <td colspan="8" style="text-align: center; padding: 2rem">ƒêang t·∫£i d·ªØ li·ªáu...</td>
          </tr>
        } @else if (users().length === 0) {
          <tr>
            <td colspan="8" style="text-align: center; padding: 2rem">Kh√¥ng t√¨m th·∫•y user n√†o.</td>
          </tr>
        } @else {
          @for (user of users(); track user.id) {
            <tr [class.locked]="user.is_locked">
              <td data-label="Avatar">
                <div class="avatar">
                  <img
                    [src]="user.avatar_url"
                    *ngIf="user.avatar_url"
                    style="width: 100%; height: 100%; border-radius: 50%"
                  />
                  <span *ngIf="!user.avatar_url">{{ user.full_name?.charAt(0) || 'U' }}</span>
                </div>
              </td>
              <td data-label="T√™n">{{ user.full_name }}</td>
              <td data-label="Email">{{ user.email }}</td>
              <td data-label="Quy·ªÅn">
                <span
                  class="badge"
                  [class.admin]="user.role === 'admin'"
                  [class.user]="user.role === 'user'"
                >
                  {{ user.role }}
                </span>
              </td>
              <td data-label="G√≥i">
                <div style="display: flex; flex-direction: column">
                  <span class="badge" [class.premium]="user.subscription_tier !== 'free'">{{
                    user.subscription_tier
                  }}</span>
                  <small *ngIf="user.subscription_expiry" style="color: #666; font-size: 0.7em">
                    H·∫øt h·∫°n: {{ user.subscription_expiry | date: 'dd/MM/yyyy' }}
                  </small>
                </div>
              </td>
              <td data-label="Ng√†y t·∫°o">{{ user.created_at | date: 'shortDate' }}</td>
              <td data-label="Tr·∫°ng th√°i">
                <span *ngIf="user.is_locked" class="badge locked">ƒê√£ kh√≥a</span>
                <span *ngIf="!user.is_locked" class="badge active">Ho·∫°t ƒë·ªông</span>
              </td>
              <td data-label="H√†nh ƒë·ªông" class="actions-cell">
                <button class="btn-icon" (click)="openEditModal(user)" title="S·ª≠a">‚úèÔ∏è</button>
                <button
                  class="btn-icon"
                  [class.unlock]="user.is_locked"
                  [class.lock]="!user.is_locked"
                  (click)="toggleLock(user)"
                  [title]="user.is_locked ? 'M·ªü kh√≥a' : 'Kh√≥a'"
                >
                  {{ user.is_locked ? 'üîì' : 'üîí' }}
                </button>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <button (click)="changePage(currentPage() - 1)" [disabled]="currentPage() === 1">Tr∆∞·ªõc</button>
    <span>Trang {{ currentPage() }} / {{ totalPages() || 1 }}</span>
    <button (click)="changePage(currentPage() + 1)" [disabled]="currentPage() >= totalPages()">
      Sau
    </button>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" *ngIf="showModal()">
  <div class="modal">
    <div class="modal-header">
      <h4>Ch·ªânh s·ª≠a User: {{ editingUser()?.full_name }}</h4>
      <button class="close-btn" (click)="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Quy·ªÅn h·∫°n (Role)</label>
        <select [(ngModel)]="editForm().role">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="form-group">
        <label>G√≥i d·ªãch v·ª• (Subscription)</label>
        <select [(ngModel)]="editForm().subscription_tier">
          <option value="free">Free</option>
          <option value="premium">Premium</option>
          <option value="pro">Pro</option>
        </select>
      </div>

      <div class="form-group">
        <label>Ng√†y h·∫øt h·∫°n</label>
        <div style="display: flex; gap: 0.5rem; align-items: center">
          <input type="date" [(ngModel)]="editForm().subscription_expiry" style="flex: 1" />
          <button class="btn-sm" (click)="extendSubscription(1)">+1 Th√°ng</button>
          <button class="btn-sm" (click)="extendSubscriptionYears(1)">+1 NƒÉm</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeModal()">H·ªßy</button>
      <button class="btn-primary" (click)="saveUser()">L∆∞u thay ƒë·ªïi</button>
    </div>
  </div>
</div>
